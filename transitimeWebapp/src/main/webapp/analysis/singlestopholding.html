<html>
<link rel="stylesheet" href="css/general.css">
<head>
<style>

body {
   margin:0;
   padding:0;
   font: 20px Arial, sans-serif;
  }

#holding_div {
	width: 98%;
	margin-top: 30px;
	margin-left: 10px;
}
.container {
    position: relative;
    width: 100%;
    height: 0;
    padding-bottom: 56.25%;
}
.mapframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 98%;
    height: 100%;
}
</style>
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="js/transiTimeHolding.js"></script>
<script src="js/transiTimeVehicles.js"></script>
<script src="js/transiTimeRoutes.js"></script>
<script src="js/transiTimeTrips.js"></script>
<script src="js/transiTimeEvents.js"></script>
<title>Vehicle Holding Times</title>
</head>

<body>
	<div id="header">
	<img class="gt-logo-svg" alt="Georgia Tech" src="http://www.gatech.edu/sites/all/themes/gt/images/logos/logo-gt.png"/>
		<a href="http://www.transitime.org">Transitime Extension: Holding
			Times for ATLANTA STREETCAR</a>					
	</div>

	<div id="holding_div">


		<table width="100%"  border="0">

			<tr>
				<td width="30%">Remaining Holding Time
					<div id="counter"></div>
					<table>
						<tr>
							<td colspan="2">Vehicle Information</td>

						</tr>
						<tr>
							<td>Vehicle ID</td>
							<td>
								<div id="vehicleid"></div>
							</td>
						</tr>
						<tr>
							<td>Time of Arrival</td>
							<td>
								<div id="timeofarrival"></div>
							</td>
						</tr>
						<tr>
							<td>Time of Departure</td>
							<td>
								<div id="timeofdeparture"></div>
							</td>
						</tr>
						<tr>
							<td>Predicted next arrival time</td>
							<td>
								<div id="nextarrivaltime"></div>
							</td>
						</tr>

					</table>

				</td>
				
				<td width="50%">
				<table>
				<tr align="justify">
					Real-Time Vehicle Location
				</tr>
				<tr>
					<div class="container">				
						<iframe src="/web/maps/map.jsp?a=ASC" frameborder="0" allowfullscreen class="mapframe">
						</iframe>
				</div>
				</tr>
				</table>
				</td>
				<td width="20%">
					
				<td>
			</tr>

		</table>


	</div>
</body>

<script>
	var host = null;
	var vehicle = null;
	var timeofarrival = new Date(0);
	var timeofdepature = new Date(0);
	var predictednextarrival = new Date(0);
	function str_pad_left(string, pad, length) {
		return (new Array(length + 1).join(pad) + string).slice(-length);
	}
	var data =  {
			vehicle: null,
			holdingTime: null,
			events : null			
	};
	
	function getData()
	{
		if(data.vehicle==null || vehicleDeparted(data, '4560595' ))
		{
			getNextVehicleArrival(host, '4560595', processNextVehicle);
		}else
		{
			getNextVehicleArrival(host, '4560595', processCurrentVehicle);
		}
		
		getStopEvents(host, '4560595' , processEvents, data);
		
		getHoldingTime(host, '4560595', vehicle, processHoldingTime, data);
		
		updateScreen(data);
	}
		

	function updateScreen(data)
	{
		if(data.vehicle != null && data.holdingTime != null && data.events != null)
		{
			console.log("Have enough data");
			
			if(data.vehicle==data.holdingTime.vehicleId)
			{
				$("#timeofdeparture").text(
						new Date(data.holdingTime.holdingTime).toLocaleTimeString());

				var holdingTimeMilliseconds = new Date(data.holdingTime.holdingTime)
						.getTime()
						- new Date(data.holdingTime.currentTime).getTime();
				
				var time = holdingTimeMilliseconds / 1000;
				
				if (time < 0)
				{	
					if(vehicleDeparted(data, '4560595' ))
						$("#counter").css({'color' : 'red','font-size' : '400%'});
					else
						$("#counter").css({'color' : 'DarkOrange','font-size' : '400%'});
				}	
				else
				{
					if(data.holdingTime.arrivalUsed == false)
					{
						$("#counter").css({'color' : 'blue','font-size' : '400%'});
					}
					else
					{
						$("#counter").css({'color' : 'green','font-size' : '400%'});
					}
				}				
				var minutes = Math.floor(time / 60);
				var seconds = time - (minutes * 60);
				$("#counter").text(str_pad_left(minutes.toFixed(), '0', 2) + ':' + str_pad_left(seconds.toFixed(), '0', 2));
			}			
		}else
		{
			console.log("Need more data");
		}
	}
	function processEvents(data, events)
	{
			 		
	};
	function processHoldingTime(data, holdingTime) {
		
	};
	function processCurrentVehicle(nextVehiclePrediction)
	{
		var l_vehicle=nextVehiclePrediction.predictions[0].dest[0].pred[0].vehicle;
		if(l_vehicle==vehicle)
		{
			var timeofarrival =  new Date(
					nextVehiclePrediction.predictions[0].dest[0].pred[0].time * 1000);
			$("#timeofarrival").text(
					timeofarrival.toLocaleTimeString());
		}
	}
	function processNextVehicle(nextVehiclePrediction) {
		vehicle = nextVehiclePrediction.predictions[0].dest[0].pred[0].vehicle;

		$("#vehicleid").text(vehicle);
		if (nextVehiclePrediction.predictions[0].dest[0].pred.length > 1) {
			timeofarrival =  new Date(
					nextVehiclePrediction.predictions[0].dest[0].pred[0].time * 1000);
			predictednextarrival = new Date(
					nextVehiclePrediction.predictions[0].dest[0].pred[1].time * 1000);
			$("#timeofarrival").text(
					timeofarrival.toLocaleTimeString());
			$("#nextarrivaltime").text(
					predictednextarrival.toLocaleTimeString());
			
		}
		
		data.vehicle=vehicle;

	};
	function vehicleDeparted(data, stopid)
	{
		for(var i =0; i< data.events.arrivalDeparture.length;i++)
		{
			data.events.arrivalDeparture[i];
			if(!data.events.arrivalDeparture[i].isArrival)
			{				 
				if(data.holdingTime !=null && data.vehicle!=null)
				{
					if(data.vehicle==data.holdingTime.vehicle) 
					{						
						if(data.arrivalDeparture[i].time > holdingTime.holdingTime || data.arrivalDeparture[i].time > data.arrivalDeparture[i-1].time  )
						{
							return true;		
						}
					}									
				}
			}
		}
		return false;
	}
	$(document).ready(function() {

		host = document.location.host;
		setInterval(function() {
			getData();
		}, 1000);		
	});
</script>

</html>