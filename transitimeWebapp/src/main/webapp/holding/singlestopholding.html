<html>
<link rel="stylesheet" href="css/general.css">
<head>
<style>

body {
   margin:0;
   padding:0;
   font: 20px Arial, sans-serif;
  }

#holding_div {
	width: 98%;
	margin-top: 30px;
	margin-left: 10px;
}
.container {
    position: relative;
    width: 100%;
    height: 0;
    padding-bottom: 56.25%;
}
.mapframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 98%;
    height: 100%;
}
</style>
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="js/transiTimeHolding.js"></script>
<script src="js/transiTimeVehicles.js"></script>
<script src="js/transiTimeRoutes.js"></script>
<script src="js/transiTimeTrips.js"></script>
<script src="js/transiTimeEvents.js"></script>
<script src="js/transiTimeUtils.js"></script>
<title>Vehicle Holding Times</title>
</head>

<body>
	<div id="header">
	<img class="gt-logo-svg" alt="Georgia Tech" src="http://www.gatech.edu/sites/all/themes/gt/images/logos/logo-gt.png"/>
		<a href="http://www.transitime.org">transitimeExtension: Holding
			Times for ATLANTA STREETCAR</a>		
       
	</div>

	<div id="holding_div">


		<table width="100%"  border="0">

			<tr>
				<td width="30%">Remaining Holding Time
					<div id="counter"></div>
					<table>
						<tr>
							<td colspan="2">Vehicle Information</td>

						</tr>
						<tr>
							<td>Vehicle ID</td>
							<td>
								<div id="vehicleid"></div>
							</td>
						</tr>
						<tr>
							<td>Time of Arrival</td>
							<td>
								<div id="timeofarrival"></div>
							</td>
						</tr>
						<tr>
							<td>Time of Departure</td>
							<td>
								<div id="timeofdeparture"></div>
							</td>
						</tr>
                        <tr>
							<td>Predicted next vehicle</td>
							<td>
								<div id="nextarrival"></div>
							</td>
						</tr>
						<tr>
							<td>Predicted arrival time</td>
							<td>
								<div id="nextarrivaltime"></div>
							</td>
						</tr>

					</table>

				</td>
				
				<td width="50%">
				<table>
				<tr align="justify">
					Real-Time Vehicle Location
				</tr>
				<tr>
					<div class="container">				
						<iframe src="/web/maps/map.jsp?a=ASC" frameborder="0" allowfullscreen class="mapframe">
						</iframe>
				</div>
				</tr>
				<tr> 
				 <div id="lastevent"></div>
				</tr>
				</table>
				</td>
				<td width="20%">
					
				<td>
			</tr>
            <tr>
                <td >
                    <div id="byline">Developed by <br/></br/>Sean Ã“g Crudden (og.crudden@gmail.com)<br/>Simon Berrebi (simon@berrebi.net)</div>
                </td>
            </tr>

		</table>
        

	</div>
</body>

<script>
	var host = null;
	var vehicle = null;
	var timeofarrival = new Date(0);
	var timeofdepature = new Date(0);
	var predictednextarrival = new Date(0);
    $("#byline").css({'color' : 'green','font-size' : '90%'});
	function str_pad_left(string, pad, length) {
		return (new Array(length + 1).join(pad) + string).slice(-length);
	}
	var data =  {
			vehicle: null,
			holdingTimeKeys:null,
			holdingTimes: {},
			events : null,	
			predictions : null
			
	};
	function vehicleToDisplay(data, stopid)
    {
        if(data.holdingTimes != null && data.events != null && data.predictions!=null)
		{
            var keys=Object.keys(data.holdingTimes);
            for (var index = 0; index < keys.length; ++index) {
                if(vehicleAtStop(data, stopid, keys[index]))
                {
                    return keys[index];
                }
            }
            return null;
                                            	
        }else
        {
            return null;
        }
    }
	function getData(data,stopid)
	{						
		getStopEvents(host, stopid , processEvents, data);
		
		getHoldingTimeKeys(host, processHoldingTimeKeys, data);
		
		getNextVehicleArrivalPredictions(host, stopid, processArrivalPredictions, data);
                    		    
        var vehicles = [];
        $.each(data.predictions, function() {
                    vehicles.push(this.vehicle);                
        });
            
        vehicles=unique(vehicles);
            
        for (var index = 0; index < vehicles.length; ++index) {
            getHoldingTime(host, stopid, vehicles[index], processHoldingTime, data);		        
        }
       
	};
		

	function updateScreen(data,stopid)
	{
     			
        var vehicle=vehicleToDisplay(data, stopid);
       
        if(vehicle!=null)
        {
            console.log("Display holding info for:"+vehicle); 
            data.vehicle=vehicle;
            $("#vehicleid").text(data.vehicle);
            
            if(data.holdingTimes[data.vehicle] != null)
		    {                       
			     console.log("Have data");									
                
                $("#timeofdeparture").text(
						new Date(data.holdingTimes[data.vehicle].holdingTime).toLocaleTimeString());
                
                $("#timeofarrival").text(
						new Date(data.holdingTimes[data.vehicle].arrivalTime).toLocaleTimeString());
                
                var holdingTimeMilliseconds = new Date(data.holdingTimes[data.vehicle].holdingTime)
						.getTime()
						- new Date(data.holdingTimes[data.vehicle].currentTime).getTime();
				
				var time = Math.abs(holdingTimeMilliseconds) / 1000;
                
                var minutes = Math.floor(time / 60);
                
				var seconds = time - (minutes * 60);
                
           
                if(holdingTimeMilliseconds>0)
                    $("#counter").css({'color' : 'green','font-size' : '400%'});
                else
                    $("#counter").css({'color' : 'red','font-size' : '400%'});
                
				$("#counter").text(str_pad_left(minutes.toFixed(), '0', 2) + ':' + str_pad_left(seconds.toFixed(), '0', 2));
		    }
            else
            {
                console.log("Need data");
                
            }
        }
        else
        {
            $("#vehicleid").text("No vehicle at stop");
            $("#timeofdeparture").text("");
            $("#timeofarrival").text("");            
            $("#nextarrivaltime").text("");
            $("#nextarrival").text("");
            $("#counter").text("00:00");
            $("#counter").css({'color' : 'blue','font-size' : '400%'});
            
        }        
        var lasteventindex=findLastEvent(data);
			
        /* This is just for debug purposes */
        if(lasteventindex>-1)
		{				
			$("#lastevent").text(JSON.stringify(data.events[lasteventindex]));
		}
        /* display the next prediction. TODO this could be a function. */
        if(data.predictions!=null)
        {
            var predictednextarrival = new Date(data.predictions[0].time * 1000);		
            $("#nextarrivaltime").text(predictednextarrival.toLocaleTimeString());
            $("#nextarrival").text(data.predictions[0].vehicle);
        }
	};
    
	function processEvents(data, events)
	{
          data.events=events.arrivalDeparture;		
	};
	function processHoldingTime(data, vehicleid, holdingTime) {
		data.holdingTimes[vehicleid]=holdingTime;
	};
	function processHoldingTimeKeys(data, holdingTimeKeys) {
		data.holdingTimeKeys=holdingTimeKeys;
		//getHoldingTime(host, '4560595', vehicle, processHoldingTime, data);
	};
	function processArrivalPredictions(predictions, data)
	{
		data.predictions=predictions.predictions[0].dest[0].pred;		
	};
	
	function vehicleAtStop(data, stopid, vehicleid)
	{		
		if(findLastEventByVehicle(data, vehicleid)>-1)
		{
			var lastEvent=data.events[findLastEventByVehicle(data, vehicleid)];
								
			if(lastEvent.isArrival)
			{
									
				return true;	
				
			}			
		}
		return false;			
	}	;
    function findLastEvent(data)
	{
		var index=-1;
		var latesttime=null;
		if(data.events !== 'undefined')
		{
			for(var i =0; i< data.events.length;i++)
			{			
				                   
                if(latesttime==null)
                {
                    latesttime=new Date(data.events[i].time);	
                    index=i;
                }else
                {
                    if(new Date(data.events[i].time) > latesttime )	
                    {
                        latesttime=new Date(data.events[i].time);
                        index=i;
                    }
                }                  				
			}
		}
		return index;
	};
	function findLastEventByVehicle(data, vehicleid)
	{
		var index=-1;
		var latesttime=null;
		if(data.events !== 'undefined')
		{
			for(var i =0; i< data.events.length;i++)
			{			
				    if(data.events[i].vehicleId===vehicleid)
                    {
               
                        if(latesttime==null)
                        {
                            latesttime=new Date(data.events[i].time);	
                            index=i;
                        }else
                        {
                            if(new Date(data.events[i].time) > latesttime )	
                            {
                                latesttime=new Date(data.events[i].time);
                                index=i;
                            }
                        }
                    }
				
			}
		}
		return index;
	};
	$(document).ready(function() {

		host = document.location.host;
        host = "127.0.0.1:8080"
		setInterval(function() {
			getData(data, "4560595");
			updateScreen(data, "4560595");
		}, 1000);		
	});
</script>

</html>